<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>바퀴벌레 볼링</title>
    <script src="/env.js"></script>
    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans KR", "Malgun Gothic", sans-serif; background:#0b1220; color:#e5e7eb; }
      .container { min-height:100%; display:flex; align-items:center; justify-content:center; padding:16px; }
      .card { width: min(720px, 92vw); background:#111827; border:1px solid #1f2937; border-radius:14px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
      .title { font-size:24px; font-weight:800; margin-bottom:8px; }
      .subtitle { color:#9ca3af; margin-bottom:16px; }
      .row { display:flex; gap:10px; flex-wrap:wrap; }
      .btn { appearance:none; border:none; border-radius:10px; padding:12px 16px; font-weight:800; cursor:pointer; }
      .btn-primary { background:#2563eb; color:#fff; }
      .btn-secondary { background:#16a34a; color:#fff; }
      .btn-muted { background:#374151; color:#e5e7eb; }
      .rank { margin-top:16px; border-top:1px solid #1f2937; padding-top:12px; display:none; }
      .list-header { display:grid; grid-template-columns: auto 1fr auto auto; gap:8px; align-items:center; color:#9ca3af; font-size:12px; padding:6px 8px; }
      .list-row { display:grid; grid-template-columns: auto 1fr auto auto; gap:8px; align-items:center; padding:10px 12px; border-radius:10px; border:1px solid #1f2937; background:#0f172a; }
      .list-row + .list-row { margin-top:6px; }
      .list-row:hover { border-color:#334155; background:#111b2e; }
      .rank-badge { min-width:36px; text-align:center; font-weight:800; border-radius:9999px; padding:4px 10px; background:#1f2937; color:#e5e7eb; }
      .rank-1 { background:#fbbf24; color:#111827; }
      .rank-2 { background:#9ca3af; color:#111827; }
      .rank-3 { background:#8b5cf6; color:#fff; }
      .score-chip { justify-self:end; padding:6px 12px; border-radius:9999px; font-weight:900; box-shadow:0 0 0 1px rgba(255,255,255,0.06) inset; border:1px solid rgba(255,255,255,0.06); }
      .score-chip.small { padding:4px 10px; font-weight:800; }
      .score-plain { background:transparent; color:#e5e7eb; border:1px solid #374151; box-shadow:none; }
      .score-1k { background:linear-gradient(90deg,#60a5fa 0%, #34d399 100%); color:#0b1220; }
      .score-5k { background:linear-gradient(90deg,#34d399 0%, #06b6d4 100%); color:#0b1220; }
      .score-10k { background:linear-gradient(90deg,#f59e0b 0%, #ef4444 100%); color:#111827; }
      .score-20k { background:linear-gradient(90deg,#ef4444 0%, #8b5cf6 100%); color:#ffffff; }
      .score-30k { background:linear-gradient(90deg,#fbbf24 0%, #ef4444 35%, #8b5cf6 70%, #06b6d4 100%); color:#111827; box-shadow:0 0 0 1px rgba(255,255,255,0.08) inset, 0 8px 24px rgba(139,92,246,0.32); }
      .loading, .empty, .error { color:#9ca3af; text-align:center; padding:16px 0; }
      .pager { margin-top:12px; display:flex; gap:8px; justify-content:flex-end; align-items:center; color:#9ca3af; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="title">바퀴벌레 볼링</div>
        <div class="subtitle">플릭으로 핀을 쓰러뜨리세요!</div>
        <div class="row">
          <button class="btn btn-primary" id="btnStart">게임 시작</button>
          <button class="btn btn-secondary" id="btnShowRank">랭킹 보기</button>
        </div>
        <div class="rank" id="rankSection">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:700;">전체 랭킹</div>
            <button class="btn btn-muted" id="btnHideRank">닫기</button>
          </div>
          <div class="list-header" id="rankHeader">
            <div>#</div>
            <div>닉네임</div>
            <div style="text-align:right;">점수</div>
            <div style="text-align:right;">기록일</div>
          </div>
          <div id="rankList"></div>
          <div class="pager">
            <button class="btn btn-muted" id="btnPrev">이전</button>
            <span id="pageInfo">페이지 1</span>
            <button class="btn btn-muted" id="btnNext">다음</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const ENV = (window.ENV||{});
      const url = ENV.SUPABASE_URL; const key = ENV.SUPABASE_ANON_KEY;
      const pageSize = 10; let page = 1; let hasNext = false;
      const elStart = document.getElementById('btnStart');
      const elShow = document.getElementById('btnShowRank');
      const elHide = document.getElementById('btnHideRank');
      const sec = document.getElementById('rankSection');
      const list = document.getElementById('rankList');
      const pageInfo = document.getElementById('pageInfo');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');

      elStart.onclick = ()=>{ location.href = 'game.html'; };
      elShow.onclick = ()=>{ sec.style.display = 'block'; page=1; loadPage(); };
      elHide.onclick = ()=>{ sec.style.display = 'none'; };
      btnPrev.onclick = ()=>{ if (page>1) { page--; loadPage(); } };
      btnNext.onclick = ()=>{ if (hasNext) { page++; loadPage(); } };

      async function loadPage(){
        list.innerHTML = '<div class="loading">불러오는 중...</div>';
        if (!url || !key) { list.innerHTML = '<div class="error">환경변수(Supabase)가 설정되지 않았습니다.</div>'; updatePageInfo(); return; }
        const offset = (page-1)*pageSize;
        const limit = pageSize + 1; // fetch one extra to detect next page
        try {
          const headers = { 'apikey': key, 'Authorization': 'Bearer ' + key };
          const endpoint = url + '/rest/v1/scores?select=nickname,score,created_at&order=score.desc&limit=' + limit + '&offset=' + offset;
          const rows = await fetch(endpoint, { headers }).then(r=>r.json());
          if (!rows || rows.length===0){ list.innerHTML = '<div class="empty">기록이 없습니다.</div>'; updatePageInfo(); return; }
          hasNext = rows.length > pageSize;
          const slice = hasNext ? rows.slice(0, pageSize) : rows;
          list.innerHTML = '';
          const fmtDate = (iso)=>{ try { return new Date(iso).toISOString().slice(0,10); } catch { return '-'; } };
          slice.forEach((row, i)=>{
            const rankNo = offset + i + 1;
            const item = document.createElement('div'); item.className = 'list-row';
            const rdiv = document.createElement('div'); rdiv.className = 'rank-badge'; rdiv.textContent = rankNo;
            if (rankNo === 1) rdiv.classList.add('rank-1');
            else if (rankNo === 2) rdiv.classList.add('rank-2');
            else if (rankNo === 3) rdiv.classList.add('rank-3');
            const nn = document.createElement('div'); nn.textContent = row.nickname || '-';
            const sc = document.createElement('div'); sc.className = 'score-chip';
            const sval = (row.score != null ? Number(row.score) : NaN);
            sc.textContent = isNaN(sval) ? '-' : sval.toLocaleString();
            if (!isNaN(sval)) {
              if (sval >= 30000) sc.classList.add('score-30k');
              else if (sval >= 20000) sc.classList.add('score-20k');
              else if (sval >= 10000) sc.classList.add('score-10k');
              else if (sval >= 5000) sc.classList.add('score-5k');
              else if (sval >= 1000) sc.classList.add('score-1k');
              else sc.classList.add('score-plain');
            } else {
              sc.classList.add('score-plain');
            }
            const dt = document.createElement('div'); dt.textContent = (row.created_at ? fmtDate(row.created_at) : '-'); dt.style.textAlign='right';
            item.append(rdiv, nn, sc, dt); list.append(item);
          });
          updatePageInfo();
        } catch(e){
          list.innerHTML = '<div class="error">랭킹을 불러오지 못했습니다.</div>';
        }
      }
      function updatePageInfo(){ pageInfo.textContent = '페이지 ' + page + (hasNext ? ' ›' : ''); }
    </script>
  </body>
  </html>
